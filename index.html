<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMi Market Update Presentation</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        /* Define custom fonts, prioritizing the specified ones with fallbacks */
        @font-face {
            font-family: 'Arial Rounded MT Bold';
            src: local('Arial Rounded MT Bold'), local('Arial Rounded MT');
        }
        @font-face {
            font-family: 'Arial Nova Light';
            src: local('Arial Nova Light'), local('Arial Nova');
            font-weight: 300;
        }
        
        /* Ensure the body uses a clean font for general text */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>

    <div id="root" class="min-h-screen p-4 flex flex-col items-center">
        <!-- React App will render here -->
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- 1. BRAND GUIDELINE CONSTANTS ---
        const COLORS = {
            darkBlue: '#01305C',      // Primary backgrounds, headers
            mediumBlue: '#005CA9',    // Accent elements
            lightBlue: '#009FE3',     // Accent elements (Requested color)
            green: '#AFCB38',         // Accent band/highlights
            orange: '#F07E26',        // Accent/chart color
        };

        const CONTACT = {
            address: 'E.ON-Allee 1, 84036 Landshut, Germany',
            phone: '+49 871 6850',
            email: 'bmi@bmi-eg.com',
            website: 'www.bmi-eg.com',
        };

        // BMi Slide Content (Updated with the latest data and lightBlue color on slide 5)
        const SLIDES = [
          {
            type: 'title',
            title: 'Market Developments in the EU Dairy Industry',
            subtitle: 'October Market Update', 
            date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
            author: 'Your BMi Market Team',
          },
          {
            type: 'content',
            heading: 'Current Market Situation: Supply and Pricing',
            accentColor: COLORS.mediumBlue,
            content: [
              'Sustained high raw milk supply in Germany and the EU, significantly above the previous year\'s level.',
              'The high raw material flow continues to **pressure prices** for many dairy products.',
              'Price corrections for farm-gate prices are expected in the near future.',
              'Competition in the food retail sector continues to stimulate sales of private-label butter.',
              'Cut cheese records price decreases despite stable domestic demand.',
            ],
          },
          {
            type: 'data',
            heading: 'EU Production: Volume Year-over-Year (Jan-Aug 2025 vs. 2024)',
            accentColor: COLORS.green,
            data: [
              { product: 'Raw Milk', change: '+7%' },
              { product: 'Butter', change: '+3.5%' },
              { product: 'Cheese', change: '+1.0%' },
              { product: 'S.M.P.', change: '+2%' },
              { product: 'Condensed Milk', change: '-10.7%' },
            ],
            note: 'Source: EUROSTAT, DG AGRI Dashboard (as of end Oct 2025)',
          },
          {
            type: 'content',
            heading: 'EU Trade Outlook: Exports and Imports (Jan-May 2025)',
            accentColor: COLORS.lightBlue,
            content: [
              '**Overall Trend:** Exports to non-EU countries are stagnating or declining, while imports, especially for butter and butter oil, are rising.',
              '**WMP Impact:** Whole Milk Powder (WMP) exports saw a sharp drop of -21% compared to the previous year.',
              '**Positive Growth:** Cheese and Whey Powder exports showed modest growth of +2%.',
              '**Consumption Milk:** Exports of consumption milk and condensed milk decreased by -8%.',
            ],
          },
          {
            type: 'content',
            heading: 'German Supply and Pricing Trends (Latest Weeks)',
            accentColor: COLORS.lightBlue, // Using light blue as requested
            content: [
              '**Raw Milk Supply:** Domestic delivery is currently stagnating but remains significantly above the previous year\'s level.',
              '**Price Correction:** Current product price developments indicate an **expected correction** in farm-gate pay prices.',
              '**Fluid Raw Materials:** Supply is stable and well-absorbed; manufacturers with free drying capacity are actively buying Skim Milk Concentrate.',
              '**Market Focus:** The focus in Milk Powder markets is shifting to 2026, with current buying interest remaining reserved for the remainder of 2025.',
            ],
          },
          {
            type: 'content',
            heading: 'Product Deep Dive: Butter and Cut Cheese',
            accentColor: COLORS.green,
            content: [
              '**Packaged Butter:** High retail sales are driven by discounter price competition (new lows seen at €1.39 for 250g).',
              '**Block Butter:** The 25kg market shows signs of **stabilization**; prices appear to have bottomed out, attracting dealer activity.',
              '**Cut Cheese:** Continued price decreases across the board despite positive sales development in German retail and stable Foodservice demand.',
              '**Export:** German cheese is regaining competitiveness in export markets due to current price drops, though buyers remain cautious.',
            ],
          },
          {
            type: 'closing',
          },
        ];

        // --- 2. LAYOUT COMPONENTS ---

        const formatContent = (text) => {
            return { __html: text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') };
        };

        const Footer = () => (
            <div 
                className="absolute bottom-0 left-0 w-full p-4 text-xs font-light text-gray-300" 
                style={{ backgroundColor: COLORS.darkBlue }}
            >
                <div className="flex justify-between items-center max-w-7xl mx-auto w-full px-4">
                    <span className="text-white">
                        Bayerische Milchindustrie eG • {CONTACT.address}
                    </span>
                    <span className="text-white">
                        {CONTACT.website} | Page
                    </span>
                </div>
            </div>
        );

        const TitleSlide = ({ title, subtitle, date, author }) => (
            <div 
                className="flex flex-col items-center justify-center h-full text-center p-12" 
                style={{ backgroundColor: COLORS.darkBlue }}
            >
                <div className="text-white text-3xl font-extrabold mb-8 p-3 border-2 rounded tracking-widest" style={{ borderColor: COLORS.green, color: COLORS.green }}>
                    BMi
                </div>
                
                <h1 
                    className="text-5xl font-extrabold mb-4" 
                    style={{ color: COLORS.green, fontFamily: "'Arial Rounded MT Bold', sans-serif" }}
                >
                    {title}
                </h1>
                
                <h2 className="text-3xl font-light text-gray-200 mb-10">{subtitle}</h2>
                
                <div className="text-xl font-medium text-white pt-8 border-t border-gray-600">
                    <p>{date}</p>
                    <p className="mt-2 text-lg text-gray-400">{author}</p>
                </div>
            </div>
        );

        const ContentSlide = ({ heading, content, accentColor }) => (
            <div className="h-full bg-white flex flex-col">
                <div className="h-4 w-full" style={{ backgroundColor: accentColor }}></div>
                
                <div className="flex flex-col p-12 flex-grow max-w-7xl mx-auto w-full">
                    <h2 
                        className="text-3xl font-extrabold mb-8 pb-3 border-b-2" 
                        style={{ color: COLORS.darkBlue, fontFamily: "'Arial Rounded MT Bold', sans-serif", borderColor: accentColor }}
                    >
                        {heading}
                    </h2>
                    
                    <ul className="space-y-4 text-xl font-light text-gray-700 list-disc pl-5">
                        {content.map((item, index) => (
                            <li 
                                key={index} 
                                className="pl-2" 
                                style={{ fontFamily: "'Arial Nova Light', sans-serif" }}
                                dangerouslySetInnerHTML={formatContent(item)} 
                            >
                            </li>
                        ))}
                    </ul>
                </div>
            </div>
        );

        const DataSlide = ({ heading, data, note, accentColor }) => (
            <div className="h-full bg-white flex flex-col">
                <div className="h-4 w-full" style={{ backgroundColor: accentColor }}></div>
                
                <div className="flex flex-col p-12 flex-grow max-w-7xl mx-auto w-full">
                    <h2 
                        className="text-3xl font-extrabold mb-8 pb-3 border-b-2" 
                        style={{ color: COLORS.darkBlue, fontFamily: "'Arial Rounded MT Bold', sans-serif", borderColor: accentColor }}
                    >
                        {heading}
                    </h2>
                    
                    <div className="bg-gray-50 p-6 rounded-lg shadow-inner">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr style={{ backgroundColor: COLORS.mediumBlue }}>
                                    <th className="px-6 py-3 text-left text-sm font-medium text-white uppercase tracking-wider rounded-tl-lg">
                                        Product
                                    </th>
                                    <th className="px-6 py-3 text-right text-sm font-medium text-white uppercase tracking-wider rounded-tr-lg">
                                        Change (YOY)
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {data.map((item, index) => (
                                    <tr key={index} className={index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}>
                                        <td className="px-6 py-4 whitespace-nowrap text-lg font-medium text-gray-900" style={{ fontFamily: "'Arial Nova Light', sans-serif" }}>
                                            {item.product}
                                        </td>
                                        <td className={`px-6 py-4 whitespace-nowrap text-right text-xl font-bold ${item.change.startsWith('+') ? 'text-green-600' : 'text-red-600'}`}>
                                            {item.change}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    <p className="mt-6 text-sm italic text-gray-500">{note}</p>
                </div>
            </div>
        );

        const ClosingSlide = () => (
            <div 
                className="flex flex-col items-center justify-center h-full text-center p-12" 
                style={{ backgroundColor: COLORS.darkBlue }}
            >
                <h1 
                    className="text-6xl font-extrabold tracking-wider mb-10" 
                    style={{ color: COLORS.lightBlue, fontFamily: "'Arial Rounded MT Bold', sans-serif" }} // Using light blue as requested
                >
                    THANK YOU FOR YOUR ATTENTION
                </h1>
                
                <div className="text-xl text-gray-200 space-y-2 mt-8">
                    <p className="font-semibold text-white">Bayerische Milchindustrie eG</p>
                    <p>{CONTACT.address}</p>
                    <p>Phone: {CONTACT.phone}</p>
                    <p>Email: {CONTACT.email}</p>
                </div>
            </div>
        );

        // --- GEMINI API FUNCTIONS AND COMPONENTS ---

        // Function for making the API call with exponential backoff
        const fetchGeminiSummary = async (prompt) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const maxRetries = 5;
            let delay = 1000;

            const systemPrompt = "You are a Senior Market Analyst for a major European dairy cooperative. Analyze the provided market update bullet points and synthesize them into a single, concise, and professional executive summary paragraph of less than 75 words. The tone must be clear, analytical, and action-oriented. Do not use markdown formatting (like bolding or list headers).";

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) {
                        // Too Many Requests, implement backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                        continue;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error generating summary. Please try again.";
                    return text;

                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    if (i === maxRetries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
            return "Failed to generate summary after multiple retries.";
        };

        // Modal Component for displaying the AI-generated summary
        const SummaryModal = ({ isOpen, onClose, title, content, isLoading }) => {
            if (!isOpen) return null;

            return (
                <div 
                    className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
                    onClick={onClose} // Close on backdrop click
                >
                    <div 
                        className="bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full transform transition-all duration-300 scale-100"
                        onClick={(e) => e.stopPropagation()} // Prevent closing when clicking inside modal
                    >
                        <div className="flex justify-between items-start border-b pb-3 mb-4" style={{ borderColor: COLORS.mediumBlue }}>
                            <h3 className="text-2xl font-bold" style={{ color: COLORS.darkBlue }}>
                                {title}
                            </h3>
                            <button 
                                onClick={onClose} 
                                className="text-gray-400 hover:text-gray-700 transition"
                                aria-label="Close"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        
                        {isLoading ? (
                            <div className="flex flex-col items-center justify-center h-24">
                                <div className="animate-spin rounded-full h-8 w-8 border-b-2" style={{ borderColor: COLORS.mediumBlue, borderTopColor: 'transparent' }}></div>
                                <p className="mt-4 text-gray-600">Analyzing market data to generate summary...</p>
                            </div>
                        ) : (
                            <p className="text-gray-800 leading-relaxed font-light whitespace-pre-wrap">
                                {content || "Failed to generate content. The slide may not contain summary-friendly data."}
                            </p>
                        )}

                        {!isLoading && (
                            <button 
                                onClick={onClose}
                                className="mt-6 w-full py-2 rounded-lg text-white font-semibold transition hover:opacity-90"
                                style={{ backgroundColor: COLORS.darkBlue }}
                            >
                                Close
                            </button>
                        )}
                    </div>
                </div>
            );
        };


        // --- 3. MAIN APP COMPONENT ---

        const App = () => {
            const [currentSlideIndex, setCurrentSlideIndex] = useState(0);
            const [summaryText, setSummaryText] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [isModalOpen, setIsModalOpen] = useState(false);
            
            const currentSlide = SLIDES[currentSlideIndex];

            const nextSlide = () => {
                setCurrentSlideIndex((prev) => Math.min(prev + 1, SLIDES.length - 1));
            };

            const prevSlide = () => {
                setCurrentSlideIndex((prev) => Math.max(prev - 1, 0));
            };
            
            const renderSlide = (slide) => {
                switch (slide.type) {
                    case 'title':
                        return <TitleSlide {...slide} />;
                    case 'content':
                        return <ContentSlide {...slide} />;
                    case 'data':
                        return <DataSlide {...slide} />;
                    case 'closing':
                        return <ClosingSlide />;
                    default:
                        return (
                            <div className="flex items-center justify-center h-full text-red-500">
                                Error: Unknown Slide Type.
                            </div>
                        );
                }
            };
            
            const handleGenerateSummary = async () => {
                setIsLoading(true);
                setIsModalOpen(true);
                setSummaryText(null); // Clear previous summary
                
                // Construct the prompt based on the current slide's content
                let promptContent = "";
                let summaryTitle = "";

                if (currentSlide.type === 'content') {
                    summaryTitle = "Executive Summary: " + currentSlide.heading;
                    promptContent = currentSlide.heading + ": " + currentSlide.content.join('; ');
                } else if (currentSlide.type === 'data') {
                    summaryTitle = "Key Data Synthesis: " + currentSlide.heading;
                    const dataString = currentSlide.data.map(d => `${d.product} changed by ${d.change}`).join('; ');
                    promptContent = currentSlide.heading + ": " + dataString;
                } else {
                    summaryTitle = "Cannot Summarize";
                    setSummaryText("This slide type (Title or Closing) does not contain key data or content points for summarization.");
                    setIsLoading(false);
                    return;
                }

                try {
                    const summary = await fetchGeminiSummary(promptContent);
                    setSummaryText(summary);
                } catch (error) {
                    setSummaryText("An error occurred while connecting to the AI service. Please check your connection.");
                } finally {
                    setIsLoading(false);
                }
            };


            return (
                <div 
                    className="flex flex-col items-center w-full" 
                    style={{ fontFamily: 'Inter, sans-serif' }}
                >
                    {/* Presentation Container */}
                    <div className="w-full max-w-5xl h-[600px] border-8 shadow-2xl relative overflow-hidden bg-white" style={{ borderColor: COLORS.darkBlue }}>
                        {renderSlide(currentSlide)}
                        {/* Footer is inside the main slide container for relative positioning */}
                        <Footer /> 
                    </div>

                    {/* Navigation Controls */}
                    <div className="mt-8 flex space-x-4 items-center">
                        <button
                            onClick={prevSlide}
                            disabled={currentSlideIndex === 0}
                            className={`px-6 py-3 font-semibold rounded-lg transition duration-150 ${
                                currentSlideIndex === 0
                                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    : 'bg-white text-gray-700 shadow hover:shadow-lg hover:bg-gray-50'
                            }`}
                        >
                            &larr; Previous
                        </button>
                        
                        <div className="flex items-center text-lg font-medium" style={{ color: COLORS.darkBlue }}>
                            Slide {currentSlideIndex + 1} of {SLIDES.length}
                        </div>
                        
                        <button
                            onClick={nextSlide}
                            disabled={currentSlideIndex === SLIDES.length - 1}
                            className={`px-6 py-3 font-semibold rounded-lg transition duration-150 ${
                                currentSlideIndex === SLIDES.length - 1
                                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    : 'text-white shadow hover:shadow-lg'
                            }`}
                            style={{ backgroundColor: COLORS.darkBlue }}
                        >
                            Next &rarr;
                        </button>

                        {/* Gemini AI Feature Button */}
                        {(currentSlide.type === 'content' || currentSlide.type === 'data') && (
                            <button
                                onClick={handleGenerateSummary}
                                disabled={isLoading}
                                className="px-6 py-3 ml-8 font-bold rounded-lg transition duration-150 text-white shadow-xl hover:shadow-2xl flex items-center space-x-2"
                                style={{ backgroundColor: COLORS.orange }}
                            >
                                <span>Generate Summary ✨</span>
                            </button>
                        )}
                    </div>
                    
                    {/* Summary Modal */}
                    <SummaryModal 
                        isOpen={isModalOpen}
                        onClose={() => setIsModalOpen(false)}
                        title={summaryText ? (currentSlide.type === 'content' ? "Executive Summary" : "Key Data Synthesis") : "AI Analyst"}
                        content={summaryText}
                        isLoading={isLoading}
                    />
                </div>
            );
        };

        // Render the App component into the root element
        const rootElement = document.getElementById('root');
        ReactDOM.createRoot(rootElement).render(<App />);
    </script>
</body>
</html>
